# 1000 章上限：风险与当前处理说明

当前产品支持最多 **1000 章**。在章节数较大（尤其接近 1000）时，存在以下风险与限制，部分已在代码中做了缓解。

---

## 一、已做缓解

### 1. 一致性检查（最重要）

- **问题**：一致性检查会把「大纲 + 各章正文摘要」拼成一段 prompt 发给 AI。若全书 1000 章，每章摘要约 1200 字，总长会远超模型上下文（如 128K tokens），导致请求失败或结果不可用。
- **处理**：在 `server/ai/deepseek.js` 的 `runConsistencyCheck` 中，仅取**最近 150 章**参与检查（`MAX_CHAPTERS_FOR_CONSISTENCY = 150`）。若全书超过 150 章，会在结果中返回 `checkedChaptersRange: { from, to, total }`，前端可展示「本次检查了第 X–Y 章（全书共 Z 章）」。

---

## 二、仍存在的风险与建议

### 2. 大纲生成（1000 章）

- **行为**：超过 12 章会走分批生成，每批 10 章。1000 章 = **100 次**顺序请求。
- **风险**：总耗时可能达到 **约 30 分钟～1 小时**（视接口延迟而定）；用户可能误以为卡死或关闭页面；存在被 AI 服务商限流的可能。
- **建议**：  
  - 前端在「生成大纲」时，若章节数 > 100，可二次确认或提示「预计耗时较长，请勿关闭页面」。  
  - 后续可考虑增大每批章节数（需兼顾单次 prompt 长度与模型上限）。

### 3. 大纲页 / 写作页：DOM 与性能

- **大纲页（CreateOutline）**：生成后会对 `outline.chapters` 做 `map`，渲染**每章一张可编辑卡片**。1000 章 = 1000 个表单项，DOM 节点很多。
- **写作页（CreateWriting）**：同样用 `chapters.map` 渲染**每章一个区块**（标题、目标、要点、字数、正文框等）。1000 章 = 长列表 + 大量输入框。
- **风险**：首屏渲染变慢、滚动卡顿、低端设备上更明显；编辑单章时 `updateChapter` 会遍历全部章节做一次 setState，章节数大时可能略卡。
- **建议**：  
  - 章节数 > 100（或 200）时，对「章节列表」做**虚拟滚动**（只渲染可视区域），可显著缓解。  
  - 或提供「折叠/只展开当前章」等简化视图。

### 4. 项目数据体积与加载

- **存储**：单项目一个 JSON 文件。1000 章 × 每章约 3000 字正文 ≈ 约 3MB+ 纯正文，再加大纲、角色等，单文件可能达到 **约 5–10MB**。
- **风险**：  
  - `readProject` / `writeProject` 每次整文件读写，大文件时 I/O 略慢。  
  - 前端 `GET /api/projects/:id` 一次拉取整本，下载与 JSON 解析时间变长，低带宽或弱设备上明显。
- **建议**：  
  - 保持当前实现即可支撑；若后续有「按章加载正文」需求，可改为分页或按章请求接口。  
  - 导出 TXT 时，若章数很多，可考虑流式输出，避免在内存中一次性拼接超大字符串（当前一般仍可接受）。

### 5. 导出 TXT

- **行为**：在内存中拼接全书行数组再 `join('\n')` 返回。
- **风险**：1000 章 × 约 3000 字 ≈ 约 3MB 文本，Node 与浏览器一般可接受；再大则更建议流式导出。
- **建议**：目前无需改；若将来支持更大体量，再改为流式写入响应。

### 6. 前文摘要（按章生成正文）

- **行为**：`buildPreviousSummaryFromProject` 只取「前几章末尾」且总长有上限（约 3000 字），不会随总章数线性增长。
- **结论**：与 1000 章上限无冲突，无需调整。

---

## 三、小结

| 项目           | 风险程度 | 当前处理 / 建议 |
|----------------|----------|------------------|
| 一致性检查     | 高       | ✅ 已限制为最近 150 章，并返回检查范围 |
| 大纲生成耗时   | 中       | ⚠️ 建议大章数时提示「耗时较长」或二次确认 |
| 大纲/写作页 DOM | 中       | ⚠️ 建议章数 >100 时考虑虚拟列表或折叠 |
| 项目文件与加载 | 低       | 可接受；必要时再做按章加载或流式导出 |
| 导出 TXT       | 低       | 当前实现可接受 |

如需进一步提高上限（如 2000 章），建议先落实「大纲/写作页虚拟滚动」和「一致性检查分批或分卷」再放开。
