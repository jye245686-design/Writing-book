# AI 小说生成 — 部署上线指南

本文说明如何将项目部署到公网，让其他人通过浏览器访问使用。支持两种方式：**单体部署**（前后端同一服务，推荐）与 **前后端分离部署**。

---

## 国内最简单：Zeabur 一键部署（推荐）

[Zeabur](https://zeabur.com) 支持国内访问，对 Node.js 项目友好，**连 GitHub 即可自动构建与部署**，无需写 Dockerfile，适合本仓库。

### 步骤

1. **代码推送到 GitHub**  
   将本项目推到一个 GitHub 仓库（确保仓库根目录有 `package.json`、`zbpack.json` 以及 `web/`、`server/`）。

2. **注册并创建项目**  
   打开 [zeabur.com](https://zeabur.com) → 用 GitHub 登录 → 点击「Create Project」→ 选择「Import GitHub Repo」并选中本仓库。

3. **部署**  
   - Zeabur 会按根目录的 `zbpack.json` 自动执行：先安装前后端依赖并构建前端，再启动后端（托管 `web/dist`）。
   - 首次部署等待构建完成即可。

4. **配置环境变量**  
   在 Zeabur 项目里打开该服务 → **Variables** 中添加：
   - `DEEPSEEK_API_KEY`：你的 DeepSeek API Key（必填）
   - `JWT_SECRET`：随机长字符串（生产环境必填，如 `openssl rand -hex 32` 生成）
   - 无需设置 `PORT`，Zeabur 会自动注入。

5. **访问**  
   部署完成后，Zeabur 会分配一个域名（如 `xxx.zeabur.app`），可直接在浏览器打开使用。需要自定义域名可在 Zeabur 控制台绑定。

项目已包含根目录 `package.json` 与 `zbpack.json`，无需再改代码即可在 Zeabur 上一键部署。

---

## 一、上线前必读

### 1.1 环境变量与安全

- **DEEPSEEK_API_KEY**（必填）：在 [DeepSeek 开放平台](https://platform.deepseek.com/) 创建并填写。**切勿提交到 Git**，部署时在托管平台「环境变量」里配置。
- **JWT_SECRET**（生产必填）：用于登录 Token 签名。请设为**随机长字符串**（如 32 位以上），否则他人可伪造登录。开发环境有默认值，生产务必覆盖。
- **PORT**（可选）：后端监听端口，多数托管平台自动注入，无需单独设置。

`.env` 已列入 `.gitignore`，不要将含真实 Key 的 `.env` 推送到仓库。

### 1.2 验证码与登录

当前为「手机号 + 验证码」登录，验证码存在服务端 JSON 文件中；开发环境下验证码会打印到后端控制台。上线后若需真实短信，需自行接入短信服务并修改 `server/auth.js` 等逻辑。

---

## 二、方式一：单体部署（推荐）

前端打包后由**同一个 Node 服务**提供静态页面和 API，用户只访问一个域名，无需配置跨域或前端 API 地址。

### 2.1 本地构建与运行

```bash
# 1. 安装依赖
cd web && npm install && cd ..
cd server && npm install && cd ..

# 2. 构建前端（输出到 web/dist）
cd web && npm run build && cd ..

# 3. 在项目根目录配置 .env（DEEPSEEK_API_KEY、JWT_SECRET 等）

# 4. 以生产模式启动后端（会托管 web/dist）
NODE_ENV=production node server/index.js
```

默认后端端口 3002，浏览器访问 `http://localhost:3002` 即可使用。若需指定端口：

```bash
PORT=3003 NODE_ENV=production node server/index.js
```

后端会检测 `web/dist` 是否存在；存在则托管静态资源，并對非 `/api` 的 GET 请求返回 `index.html`（支持前端路由如 `/create/writing/xxx`）。

### 2.2 自定义前端输出目录（可选）

若构建产物不在 `web/dist`，可通过环境变量指定：

```bash
PUBLIC_DIR=/path/to/your/dist NODE_ENV=production node server/index.js
```

### 2.3 部署到云平台（思路）

任选一种「能跑 Node + 设置环境变量」的平台即可，常见示例：

| 平台 | 做法概要 |
|------|----------|
| **Railway** | 连接 Git 仓库 → 根目录 Build 填 `cd web && npm run build && cd ../server && npm install`，Start 填 `NODE_ENV=production node server/index.js`，工作目录选项目根；在 Variables 里设 `DEEPSEEK_API_KEY`、`JWT_SECRET`。 |
| **Render** | New → Web Service → 连仓库，Root 保持仓库根。Build: `cd web && npm install && npm run build && cd ../server && npm install`；Start: `NODE_ENV=production node server/index.js`（从仓库根执行，后端会自动找到 `web/dist`）。在 Environment 中设置 `DEEPSEEK_API_KEY`、`JWT_SECRET`。 |
| **fly.io** | 在项目根建 `Dockerfile`：多阶段构建，先 `cd web && npm run build`，再 `cd server && npm install`，最后 `NODE_ENV=production node server/index.js`，并保证运行时能访问到 `web/dist`。 |
| **自建 VPS** | 装 Node 18+，克隆代码 → 在根目录执行上述「本地构建与运行」；用 systemd 或 pm2 守护进程，反向代理（Nginx/Caddy）绑定域名并做 HTTPS。 |

**国内备选（需 Dockerfile）**：**腾讯云 Cloud Run**、**阿里云** 等若支持从代码仓库部署并运行 Docker，可使用项目根目录自带的 `Dockerfile`（多阶段构建：构建前端 → 运行后端并托管静态）。在控制台选择「从源码部署」并指定 Dockerfile 路径，在环境变量中配置 `DEEPSEEK_API_KEY`、`JWT_SECRET`；若平台要求固定端口，一般会注入 `PORT`，后端已读取 `process.env.PORT`。

**注意**：若 Start 命令是在 `server` 目录下执行（如 `cd server && node index.js`），则 `index.js` 里默认的 `publicDir` 是 `path.resolve(__dirname, '..', 'web', 'dist')`，即项目根下的 `web/dist`，只要构建阶段在根目录生成了 `web/dist` 即可。若平台从项目根执行（如 `node server/index.js`），则无需改 `PUBLIC_DIR`。

---

## 三、方式二：前后端分离部署

前端与后端分别部署到不同域名/子域名（例如前端 Vercel、后端 Railway）。

### 3.1 后端

- 将 **server** 部署到任意支持 Node 的平台（Railway、Render、fly.io 等）。
- 启动命令：`node index.js` 或 `NODE_ENV=production node index.js`（**不要**在后端开启静态托管，即不要有 `web/dist` 或 `PUBLIC_DIR` 指向前端构建产物）。
- 环境变量：`DEEPSEEK_API_KEY`、`JWT_SECRET`、`PORT`（按需）。
- 后端已开启 `cors({ origin: true })`，任意前端域名均可请求；若需限制，可改为具体 origin 列表。

### 3.2 前端

- 构建时**必须**指定后端 API 的完整地址，否则浏览器会请求到前端自己的域名导致 404。
- 在构建环境设置环境变量（示例）：

  ```bash
  VITE_API_BASE_URL=https://你的后端域名
  ```

  例如后端部署在 `https://ai-writing-api.railway.app`，则：

  ```bash
  VITE_API_BASE_URL=https://ai-writing-api.railway.app npm run build
  ```

- 将 `web/dist` 部署到 Vercel、Netlify、Cloudflare Pages 等静态托管；若使用 Vercel，在 Project Settings → Environment Variables 中为 Production 添加 `VITE_API_BASE_URL`，再执行 Build。

### 3.3 注意

- `VITE_API_BASE_URL` 会在构建时打进前端资源，换后端地址需重新构建并重新部署前端。
- 后端域名若为 HTTPS，请直接写 `https://...`，避免混合内容问题。

---

## 四、上线后检查

1. **健康检查**：访问 `https://你的域名/api/health`，应返回 `{ "ok": true }`。
2. **前端**：打开首页，能进入「新建小说」流程；在设定页可生成书名、角色、大纲（会调用 DeepSeek，需 API Key 有效）。
3. **登录**：使用手机号 + 验证码登录（验证码目前为开发逻辑，上线后需接短信或保留控制台/日志查看方式）。
4. **自测脚本**（需能访问后端）：在 `server` 目录执行 `PORT=你的端口 npm run test:api`（若后端端口非 3002，设置 `PORT` 与平台一致）。

---

## 五、可选：域名与 HTTPS

- **云平台自带域名**：Railway、Render、Vercel 等会提供 `xxx.railway.app`、`xxx.onrender.com` 等，通常已带 HTTPS，可直接用。
- **自有域名**：在平台绑定自定义域名，并按平台说明配置 DNS（CNAME 或 A 记录）。HTTPS 一般由平台自动签发。
- **自建 VPS**：用 Nginx 或 Caddy 做反向代理，将 `https://你的域名` 代理到本机 `http://127.0.0.1:3002`，并配置 SSL（如 Let’s Encrypt）。

---

## 六、简要对照

| 项目 | 单体部署 | 前后端分离 |
|------|----------|------------|
| 前端构建 | `cd web && npm run build` | 同上，且设置 `VITE_API_BASE_URL=后端地址` |
| 后端启动 | `NODE_ENV=production node server/index.js`（从项目根），并存在 `web/dist` | 仅启动 API，不托管静态 |
| 用户访问 | 只访问后端域名（同一域名下前端 + API） | 访问前端域名，前端请求后端域名 |
| 适用场景 | 一台服务、一个域名即可 | 前端/后端需独立扩展或不同平台 |

按上述步骤配置环境变量并选择一种部署方式，即可将项目上线供他人使用。若你选定具体平台（如 Railway 或 Vercel），可再根据该平台的控制台选项对照本文「构建命令 / 启动命令 / 环境变量」逐项填写。
