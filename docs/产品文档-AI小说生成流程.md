# AI 小说生成 - 产品文档（PRD）

**版本**：v1.3  
**更新日期**：2025-02-14  
**状态**：开发中，流程以本文档为准。

**变更说明（v1.1）**：流程顺序调整为「书名 → 角色设定（选择/自定义）→ 大纲生成」；角色阶段提前，支持用户先选/先定角色再生成大纲。

**变更说明（v1.2）**：新增「十、用户功能规划」；登录方式采用**手机号 + 验证码**，项目存储采用**数据库**（与现有文件存储的迁移在阶段 2 完成）。

**变更说明（v1.3）**：新增「十一、1000 章上限：风险与已落实措施」；采纳其余风险与建议并落实：大纲生成大章数二次确认、大纲/写作页章数过多时分页或折叠、一致性检查范围说明、项目体积与导出说明。

---

## 一、项目概述与目标

### 1.1 产品定位

面向「AI 写作一整本小说」的 Web 应用：用户通过选择世界背景与题材，由 AI 生成书名，用户**先设定或选择角色**，再生成大纲并确认，最后按章节生成正文；支持角色自定义与一致性检查，为后续 App 端数据互通预留能力。

### 1.2 目标用户

- 网文/小说创作者（个人或小团队）
- 希望用 AI 辅助完成从构思到成稿全流程的用户
- 未来扩展：移动端用户（灵感记录、碎片写作与数据同步）

### 1.3 核心目标

- **流程清晰**：世界背景 → 题材 → 书名 → **角色设定（选择/自定义）** → 大纲生成与确认 → 按章生成 → 一致性检查 → 导出。
- **用户可控**：书名、**角色**、大纲、每章字数均可由用户选择或修改，关键节点需用户确认后再进入下一阶段。
- **质量可控**：通过「每章 brief + 前文摘要 + 角色设定」保证连贯性，通过一致性检查与锁定机制减少前后矛盾。
- **可扩展**：数据与接口设计支持后续 App 互通（账号、项目、章节、导出格式等）。

---

## 二、用户角色与使用场景

| 角色     | 说明                     | 主要场景                         |
|----------|--------------------------|----------------------------------|
| 创作者   | 使用本系统完成小说创作   | 从零创建新书、修改大纲、按章生成 |
| 系统     | AI 与后台服务            | 生成书名/大纲/角色/正文、一致性检查 |

（当前版本不区分多角色权限，仅「创作者」视角；后续可扩展审核、协作等角色。）

---

## 三、完整流程总览

```
[阶段0] 世界背景 + 题材（+ 可选：核心创意/一句话梗概）
    ↓
[阶段1] AI 生成候选书名 → 用户选择/修改 → 确定书名（+ 可选：全书一句话承诺）
    ↓
[阶段2] 角色设定：用户添加/编辑/删除角色（姓名必填，身份、性格、目标、与主角关系、说话风格等选填）；可选：AI 推荐角色后用户选用或修改
    ↓
[阶段2 确认] 用户确认角色列表，进入下一步
    ↓
[阶段3] AI 根据 书名+背景+题材+角色+章节数 生成大纲（每章：标题 + 一句话目标 + 3～5 要点）
    ↓
[阶段3 确认] 用户修改或确认大纲（支持单章编辑、整份重新生成）
    ↓
[阶段4] 按章节顺序生成正文（每章字数可自定义，支持锁定与重写）
    ↓
[阶段5] 一致性检查（时间线/人物/设定）→ 标出问题供用户修改
    ↓
[阶段6] 导出（TXT/Word/JSON 等）
```

**关键步骤**：**角色设定**（阶段2，先于大纲）、**一致性检查**（阶段5）。

---

## 四、各阶段详细说明

### 4.1 阶段 0：世界背景与题材

| 项目     | 说明 |
|----------|------|
| 输入     | 用户选择或填写：**世界背景**（如古代/末世/星际/现代）、**题材**（如玄幻/言情/悬疑/都市）。可选：**核心创意**或**一句话梗概**（如「废柴逆袭 + 宗门争霸」）。 |
| 输出     | 形成「创作设定」对象，供后续书名、大纲、正文生成使用。 |
| 交互     | 下拉/标签选择 + 可选文本框；支持保存为模板供下次使用（可选实现）。 |

### 4.2 阶段 1：书名生成与确定

| 项目     | 说明 |
|----------|------|
| 输入     | 世界背景、题材、（若有）核心创意/一句话梗概。 |
| 输出     | AI 生成 **3～5 个候选书名**；用户选择其一或自行修改后**确定最终书名**。可选：生成**全书一句话承诺**（用于约束后续大纲与正文不跑题）。 |
| 交互     | 展示候选列表，支持「选用」「编辑后选用」；确定后进入**角色设定**。 |

### 4.3 阶段 2：角色设定（先于大纲）

| 项目     | 说明 |
|----------|------|
| 输入     | 书名、世界背景、题材、（若有）全书一句话承诺。 |
| 输出     | 用户**自定义角色列表**：每条含姓名（必填）、身份、性格、目标、与主角关系、口头禅/说话风格等。**已支持**：**AI 推荐角色**（接口 `POST /api/ai/characters/suggest`），用户点击后获取 3～8 个候选角色，可编辑或增删再确认。 |
| 用户操作 | **AI 推荐角色**、**添加角色**、**编辑/删除**单条、**确认角色**后进入大纲生成。至少保留一名角色（姓名非空）方可进入下一步。 |
| 约束     | 角色确认后，在大纲生成与按章生成时作为固定上下文传入，保证人物一致性。 |

### 4.4 阶段 3：大纲生成与确认

| 项目     | 说明 |
|----------|------|
| 输入     | 最终书名、世界背景、题材、**已确认角色列表**、**用户选择的章节数**、（若有）全书一句话承诺。 |
| 输出     | **大纲**：每章包含 **章标题**、**本章一句话目标**、**3～5 个关键要点**（关键事件/转折/出场人物/结尾悬念等）。可选：**分卷**（如每 N 章为一卷）。 |
| 实现说明 | **已落实**：大纲生成接口接收 `characters` 参数；前端调用时传入已确认角色列表；AI 提示词中已强调「根据下列角色设计章节与冲突」，保证大纲与角色一致。 |
| 用户操作 | **确认整体** / **单章编辑**（改标题、目标、要点）/ **请求重新生成**（单章或整份）。 |
| 约束     | 大纲未确认前，不可进入按章生成正文。 |

### 4.5 阶段 4：按章节生成正文

| 项目     | 说明 |
|----------|------|
| 输入     | 每章生成时传入：全局设定（背景+题材+书名+一句话承诺）、**角色设定摘要**、**本章 brief**（标题+目标+要点）、**前文摘要**（前几章或上一章摘要/关键事件+人物状态）、**用户自定义本章字数**（如 2000/3000/4000）。 |
| 输出     | 本章正文；用户可**重写本章**或**微调后继续**。 |
| 机制     | **逐章顺序生成**；用户确认的章节可**锁定**，锁定后仅可手动编辑，不再被自动重写，避免级联错误。 |
| 可选     | 「本章情绪/悬念强度」等简单选项，用于控制节奏。 |
| **已落实** | 写作页按大纲逐章展示；每章可设字数（500～8000）、生成本章/重写、正文可编辑、保存、锁定本章；前文摘要由后端从已持久化章节取末尾拼接。**持久化**：确认大纲时创建项目（POST /api/projects），写作页通过 projectId 加载/保存，章节生成与编辑写入 `server/data/projects/`，刷新不丢失。 |

### 4.6 阶段 5：一致性检查

| 项目     | 说明 |
|----------|------|
| 输入     | 全书正文 + 大纲 + 角色设定 + 世界观设定。 |
| 输出     | **一致性报告**：时间线矛盾、人物行为/性格与设定冲突、与大纲严重偏离等；**标出问题章节/段落**，供用户决定是否重写该章或该段。 |
| 交互     | 报告可逐条查看、定位到具体章节与段落；用户修改后支持「再次检查」。 |
| **已落实** | 写作页提供「发起检查」按钮；后端 POST /api/projects/:id/consistency/run 调 AI 分析各章摘要与设定/大纲/角色，返回 issues（type/severity/chapterIndex/message/suggestion）；报告展示在写作页，可点击「第 N 章」滚动定位；报告持久化在项目内。 |

### 4.7 阶段 6：导出

| 项目     | 说明 |
|----------|------|
| 输出格式 | 至少支持 **TXT**；建议支持 **Word**、**JSON**（含章节结构，便于 App 互通）。 |
| 内容     | 可选：仅正文 / 正文+目录 / 正文+角色设定+大纲（附录）。 |
| **已落实** | 写作页提供「导出 TXT」；**仅支持 TXT**。可选 **导出全部有正文的章节** 或 **仅已锁定章节**；选「仅已锁定」时可多选要导出的已锁定章节，方便按需上传书城。GET /api/projects/:id/export?format=txt&scope=all|locked&chapters=1,2,3（可选）；前端 fetch + Blob 触发下载。 |

---

## 五、功能清单（开发参考）

| 序号 | 功能模块           | 功能点                             | 优先级 |
|------|--------------------|------------------------------------|--------|
| F1   | 创作设定           | 选择世界背景、题材；可选核心创意   | P0     |
| F2   | 书名生成           | 生成 3～5 候选；选择/编辑确定      | P0     |
| F3   | 可选一句话承诺     | 根据书名生成全书一句话承诺         | P1     |
| F4   | 角色设定           | 用户添加/编辑/删除角色；可选 AI 推荐；确认后进入大纲 | P0     |
| F5   | 大纲生成           | 按章节数+角色生成每章标题+目标+要点 | P0     |
| F6   | 大纲编辑与确认     | 单章编辑、整份重生成、确认         | P0     |
| F7   | 按章生成正文       | 字数自定义、前文摘要、锁定机制     | P0     |
| F8   | 章节重写与锁定     | 单章重写、锁定/解锁                | P0     |
| F9   | 一致性检查         | 时间线/人物/设定冲突检测与报告     | P0     |
| F10  | 导出               | TXT；可选 Word、JSON               | P0/TXT，P1 其他 |
| F11  | 项目与书籍管理     | 创建/保存/列表/继续编辑            | P0     |
| F11 已落实 | 项目列表与继续写 | GET /api/projects 列表；首页「我的项目」可继续写。 | - |
| F12  | 可选分卷           | 大纲分卷展示与编辑                 | P2     |
| F13  | 本章情绪/悬念选项  | 控制单章节奏                       | P2     |

- **P0**：首版必须；**P1**：首版建议；**P2**：后续迭代。

---

## 六、非功能需求与约束

- **性能**：大纲生成、单章正文生成需在合理时间内返回（建议单章生成超时与重试策略）。
- **可扩展**：接口与数据模型需考虑后续 App 互通（用户、项目、章节、导出结构）。
- **安全与合规**：若涉及用户账号与持久化，需考虑鉴权与数据隔离；生成内容需符合平台内容规范。
- **兼容**：前端需适配常见浏览器；后端接口设计为无状态，便于水平扩展。

### 6.1 已落实：使用说明与自测

- **README**：项目根目录 README 已补充本地运行步骤、环境变量（DEEPSEEK_API_KEY、PORT、VITE_API_BASE_URL）、使用流程简述（我的项目、导出、一致性检查）、自测命令说明。
- **自测**：`server` 目录下 `npm run test:api` 依次校验健康检查、创建项目、**项目列表**、**锁定章节**、**导出 TXT**，便于交付前快速回归。

### 6.2 已落实：操作反馈与错误提示

- **成功提示**：保存、锁定、导出、一致性检查完成后，页面展示绿色成功文案（如「已保存」「已锁定」「已导出，请查看下载」「一致性检查完成」），约 3 秒后自动消失。
- **统一错误文案**：网络异常或连接失败时，前端统一展示「网络异常，请稍后重试」；其他错误展示服务端返回或业务文案。

---

## 十、用户功能规划

用户功能按阶段实施，登录方式为**手机号 + 验证码**，项目数据存储为**数据库**（阶段 2 完成项目与用户的绑定与迁移）。

### 10.1 阶段 1：账号与鉴权（第一步）

| 项目 | 说明 |
|------|------|
| 用户存储 | 使用数据库存储用户（如 SQLite/MySQL）；表：用户基本信息（id、手机号、创建时间等）。**已落实**：当前采用 JSON 文件（`data/users.json`、`data/verification_codes.json`）实现，无需原生编译，便于部署；阶段 2 项目存储可单独接入数据库。 |
| 验证码 | 发送验证码接口（如 `POST /api/auth/send-code`），验证码入库并设置有效期（如 5 分钟）；开发阶段可控制台输出或 mock，生产接入短信服务（如阿里云、腾讯云短信）。 |
| 注册/登录 | 手机号 + 验证码验证通过即登录；若用户不存在则自动注册。接口如 `POST /api/auth/login`，返回 JWT 及当前用户信息。 |
| JWT 鉴权 | 除健康检查、发送验证码、登录外，其余 API 需携带有效 JWT；服务端中间件校验 token，并将当前用户写入请求上下文（如 `req.user`），供后续接口使用。 |

**交付物**：用户表与验证码表、发送验证码与登录 API、JWT 签发与鉴权中间件；前端可在后续阶段接入登录页与请求头携带 token。

### 10.2 阶段 2：项目归属与数据库存储

| 项目 | 说明 |
|------|------|
| 项目与用户绑定 | 项目数据增加 `userId`（或 `ownerId`）；创建/读取/列表/更新/导出等接口均按当前登录用户过滤，仅允许操作自己的项目。 |
| 项目存数据库 | 项目存储从文件迁移到数据库（表结构含：id、userId、标题、设定、大纲、章节等）；原有文件存储可在迁移时一次性导入或双写过渡。 |
| 接口鉴权 | 所有项目相关接口已受 JWT 保护，且读写范围限定为当前用户。 |

**交付物**：项目表设计、迁移脚本或双写逻辑、接口按 userId 过滤与校验。

### 10.3 阶段 3：前端登录与请求态

| 项目 | 说明 |
|------|------|
| 登录/注册页 | 前端提供登录页（输入手机号、获取验证码、输入验证码并登录）；未登录访问首页/创作设定时跳转登录或提示登录。 |
| 请求头带 token | 前端在请求拦截器或 fetch 封装中为需鉴权接口自动添加 `Authorization: Bearer <token>`；token 存储方式（如 localStorage/sessionStorage）由前端约定。 |
| 登出与过期 | 支持退出登录（清除本地 token）；token 过期时接口返回 401，前端跳转登录或提示重新登录。 |

**交付物**：登录/注册页、路由与鉴权状态、请求封装与 401 处理。

### 10.4 阶段 4：个人资料与安全（可选）

| 项目 | 说明 |
|------|------|
| 个人资料 | 昵称、头像等；接口如 `GET /api/me`、`PATCH /api/me`，用于首页/导航栏展示当前用户。 |
| 写作偏好 | 默认题材、默认字数等，存在用户配置中，创作设定页可预填。 |
| 安全与体验 | 修改密码（若后续支持密码登录）、忘记密码；退出登录、多设备登录策略（如允许多端同时在线）。 |

### 10.5 后续扩展（按需）

- 第三方登录（微信/QQ/Google 等）。
- 协作：项目分享给他人只读/可编辑。
- 计费与限制：按用户限制项目数、章节数、AI 调用次数等。

---

## 十一、1000 章上限：风险与已落实措施

产品支持最多 **1000 章**。章数较大时存在以下风险，已按建议落实对应措施并写入《接口与状态设计》与代码。

### 11.1 一致性检查（已落实）

- **风险**：全书 1000 章时，将「大纲 + 各章正文摘要」拼成 prompt 会远超模型上下文，导致请求失败。
- **已落实**：后端仅取**最近 150 章**参与一致性检查；若全书超过 150 章，接口返回 `checkedChaptersRange: { from, to, total }`，前端展示「本次检查了第 X–Y 章（全书共 Z 章）」。

### 11.2 大纲生成耗时（已落实）

- **风险**：1000 章分批生成约 100 次请求，总耗时可能 30 分钟～1 小时，用户可能误以为卡死或关闭页面。
- **已落实**：当章节数 > 100 时，点击「生成大纲」前弹出二次确认，提示「预计耗时较长（约 30 分钟～1 小时），请勿关闭页面。是否继续？」。

### 11.3 大纲页 / 写作页 DOM 与性能（已落实）

- **风险**：1000 章即 1000 张可编辑卡片或 1000 个写作区块，首屏渲染与滚动卡顿。
- **已落实**：  
  - **大纲页**：当已生成大纲的章数 > 100 时，采用**分页展示**可编辑列表（每页 50 章，支持上一页/下一页），减少单屏 DOM 数量。  
  - **写作页**：当章数 > 100 时，采用**折叠列表 + 只展开当前章**：先展示章节索引列表（每页 50 条），点击某章后仅展开该章完整内容进行编辑，避免一次性渲染全部章节区块。

### 11.4 项目数据体积与加载（说明）

- **风险**：1000 章 × 约 3000 字/章，单项目 JSON 可能约 5–10MB，读写与首屏加载变慢。
- **说明**：当前实现可支撑；若后续有「按章加载正文」需求，可改为分页或按章请求；导出 TXT 体量较大时可考虑流式输出（当前一般仍可接受）。

### 11.5 导出 TXT（说明）

- **说明**：在内存中拼接全书后返回，1000 章量级可接受；若将来支持更大体量，可改为流式写入响应。

### 11.6 前文摘要（无额外风险）

- **说明**：按章生成正文时的前文摘要已有长度上限（约 3000 字），不随总章数线性增长，与 1000 章上限无冲突。

---

## 七、后续扩展方向（不纳入首版范围）

- 用户账号体系与多端登录：见**十、用户功能规划**，按阶段实施。
- App 端：灵感记录、碎片写作、与 Web 项目/章节同步。
- 协作：多人共创、评论与审阅。
- 更多导出格式与排版模板。
- 伏笔管理与「故事圣经」可视化。

---

## 八、文档与开发衔接

- 开发实现时以本文档为准，如有变更需同步更新本文档版本与变更说明。
- 接口与状态设计见同目录下 **《接口与状态设计》** 文档，两文档共同作为开发依据。
- **流程变更时**：除修改代码外，须同步更新本文档与《接口与状态设计》，并在两处注明变更说明与阶段顺序。
- **建议落实时**：当采纳并实现本文档或接口文档中的「建议」「后续扩展」时，须在对应文档中补充已落实内容（如阶段说明、接口参数、评价与建议中的「已落实」说明）；见项目规则「建议落实同步文档」。

---

## 九、流程变更评价与建议（v1.0 → v1.1）

### 9.1 新旧流程对比

| 维度     | 旧流程（v1.0）                    | 新流程（v1.1）                               |
|----------|-----------------------------------|----------------------------------------------|
| 顺序     | 书名 → 大纲 → 角色 → 按章生成     | 书名 → **角色** → **大纲** → 按章生成        |
| 角色输入 | 依赖「已生成的大纲」再生成角色     | 用户先**选择/自定义角色**，再生成大纲        |
| 用户控制 | 角色由 AI 生成后编辑               | 角色以用户添加/编辑为主，可选 AI 推荐         |

### 9.2 评价

- **优点**
  - **用户意图前置**：先定「谁来讲故事」，再生成「讲什么」，更符合「人设驱动」的创作习惯，减少大纲与角色脱节。
  - **减少返工**：若先出大纲再出角色，容易出现角色与剧情不匹配需回头改大纲；先角色后大纲，大纲可在一开始就考虑已定角色。
  - **灵活性**：支持纯手动添加角色、或未来「AI 推荐 + 用户选用」，适配不同创作习惯。

- **注意点**
  - **大纲生成需带入角色**：**已落实**——后端接收 `characters`，前端传参，提示词中已明确「根据下列角色设计章节与冲突」。
  - **角色为空或过少**：产品上已约束「至少一名角色（姓名非空）方可进入下一步」；若后续支持「无角色也生成大纲」，需在文档与接口中单独说明。

### 9.3 建议与已落实情况

- **短期（已落实）**：在大纲生成接口中显式传入 `characters`，AI 提示词中已强调「根据下列角色设计章节与冲突」；前端大纲页请求体已包含 `characters`。
- **后续（已落实）**：「AI 推荐角色」已实现：后端提供 `POST /api/ai/characters/suggest`，根据书名+设定生成 3～8 个候选角色；角色页提供「AI 推荐角色」按钮，用户可选用、编辑后确认。
- **文档与代码一致**：已纳入项目规则——流程变更须同步更新产品文档与接口/状态设计；**建议落实时**须在文档中补充已落实内容（见规则「建议落实同步文档」）。
